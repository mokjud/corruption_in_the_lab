---
title: "Corruption in the lab"
author: "Fedor Anna, Mokos Judit"
date: "19/12/2018"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

rm(list=ls())
N=10 # number of participants in the dummy data
set.seed(1)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(rmarkdown)
library(dplyr)
library(ggplot2)
```

# Description of the experiment
    
Sequential dyadic die-rolling task  
Two-by-two design:
    
* Game: simple game or charity game
* Partner: simulated honest partner or simulated dishonest partner  

Participants are randomly assigned to one of the four conditions:

* SH: simple game with honest partner
* SD: simple game with dishonest partner
* CH: charity game with honest partner
* CD: charity game with dishonest partner  

Each participant plays 20 rounds of the game. A round of game consists of the following steps:

1. Participant learns the reported number of the supposed partner
2. Participant throws a dice
3. Participant reports the number 
4. Both players get a score according to the reported numbers: the score is the reported value, if they reported a double; otherwise it's 0
5. In the charity game a charity foundation gets a small amount of donation  

# Dummy data

Data frame column names (each row is a dice roll):

* ID: random ID of participant (10000:99999)
* Game: simple or charity (S/C)
* Partner: honest or dishonest (H/D)
* Condition: one of the four experimental conditions (SH, SD, CH, CD)
* Index: index of round of game (1:20)
* ValueA: value of simulated dice roll (1:6)
* ValueB: value of participant's reported dice roll (1:6)
* Double: whether the participant reported a double (1/0)
* Q1: answer to first questionnaire quiestion (a random letter)
* Q2: answer to second questionnaire question (a random letter)
* Fingerratio: ratio of two fingers (normal distribution, mean=1, sd=0.1)
* Saliva: ??? (normal distribution, mean=3, sd=1)

```{r Generate dummy data}

IDs <- sample(10000:99999, N)
games <- sample(c("S", "C"), N, replace=TRUE)
partners <- sample(c("H", "D"), N, replace=TRUE)
conditions = paste(games, partners, sep="")

A_honest <- sample(1:6, 20, replace=TRUE)
A_dishonest <- sample(4:6, 20, replace=TRUE)

ValueAs <- vector("integer", N*20)
for (i in 1:N) {
  if (partners[i] == "H") {ValueAs[((i-1)*20+1) : ((i-1)*20+20)] <- A_honest}
  if (partners[i] == "D") {ValueAs[((i-1)*20+1) : ((i-1)*20+20)] <- A_dishonest}
}

fingerratios <- rnorm(N, mean = 1, sd = 0.1)
salivas <- rnorm(N, mean = 3, sd = 1)

rawdata <- data.frame(
  ID = rep(IDs, times = 1, length.out = NA, each = 20), 
  Game = rep(games, times = 1, length.out = NA, each = 20), 
  Partner = rep(partners, times = 1, length.out = NA, each = 20), 
  Condition = rep(conditions, times = 1, length.out = NA, each = 20),
  Index = rep(1:20, N), 
  ValueA = ValueAs, 
  ValueB = sample(1:6, N*20, replace = TRUE), 
  Double = vector("logical", N*20),
  Q1 = sample(letters, N*20, replace = TRUE), 
  Q2 = sample(letters, N*20, replace = TRUE),
  Fingerratio = rep(fingerratios, times = 1, length.out = NA, each = 20),
  Saliva = rep(salivas, times = 1, length.out = NA, each = 20))

rawdata <- mutate(rawdata, Double = ifelse(ValueA==ValueB, TRUE, FALSE))

```
# Data checking

* Check if every participant had 20 rounds  
  + Delete participants who had less than 20 rounds  
  + Delete excess rounds for each participant  
* Check if there is any missing data (columns)  

```{r Data checking}

```

# Figures

## Scatter plots of individual behavior
These should be based on Weisel & Shalvi, 2015, Fig. S10.  
One plot per participant. Plots from the same condition should be compiled into one composite figure.  

```{r Scatter plots}

person <- as.factor(unique(rawdata$ID)) 

for(i in person){

  figure1 <- ggplot(data=filter(rawdata, ID==i), aes(x=Index))+
    geom_point(aes(y=ValueA), shape=1, size=5)+
    geom_point(aes( y=ValueB), shape=3, size=2)+
    theme_classic()+
  scale_x_continuous(name="Period")+
  scale_y_continuous(name="Report")
  
  cat(" subject's ID:",  paste(i), "  \n")  
  print(figure1)
  cat("  \n")
}
```

## Heat map to demonstrate the distribution of reported numbers 
Like Weisel & Shalvi, 2015, Fig. 2, but instead of circles, each rectangle should be color coded according the number of observations within them.  
One figure per condition.  

```{r Heat maps}

cond <- as.factor(unique(rawdata$Condition))

for(i in cond){
  heatmap_df <- data.frame(count(filter(rawdata, Condition==i), ValueA, ValueB))
  
  figure2 <- ggplot(data=heatmap_df, aes(x=ValueA, y=ValueB))+
    geom_tile(aes(fill=n))+
    theme_classic()+
    scale_x_continuous(breaks=c(1:6))+
    scale_y_continuous(breaks=c(1:6))+
    scale_fill_gradient(low = "white", high = "black")
  
  cat("  \n Condition:",  paste(i), "  \n")  
  print(figure2)
  cat("  \n")
}

```

## Box plots of the mean number of doubles
One box for each condition on the same figure  
(Mean reports: does not make sense in our case, because player A is simulated)  

```{r Box plots}

person <- as.factor(unique(rawdata$ID)) 
cond <- as.factor(unique(rawdata$Condition))

# a <- c()
# for(j in cond){
#   for(i in person){
#     a[i] <- length(which(filter(filter(rawdata, Condition==j), ID==i)$ValueA == filter(rawdata, ID==i)$ValueB)) #count doubles
#     a.df <- data.frame(double=a, ID=names(a)) #make data.frame 
#     rownames(a.df) <- NULL
#     
#     
#     figure3 <- ggplot(data=a.df, aes(y=a))+
#       geom_boxplot()+
#       theme_minimal()+
#       scale_y_continuous(name='number of doubles per 20 rounds')+
#       scale_x_continuous(breaks=c())
#     
#   cat("  \n Condition:",  paste(j), "  \n")  
#   print(figure3)
#   cat("  \n")
#     
#   }
#   
# }

```

# Statistics

## Summary of data

Summary of groups and participants:
```{r Create useful variables from raw data}

participants <- rawdata %>%
  group_by(ID) %>%
  summarize(
    Condition = unique(Condition), 
    Nbof_doubles = sum(Double), 
    Avg_report = mean(ValueB))

groups <- participants %>%
  group_by(Condition) %>%
  summarize(
    Nbof_participants = n_distinct(ID),
    Nbof_doubles = sum(Nbof_doubles),
    Avg_nbof_doubles = Nbof_doubles/Nbof_participants,
    Avg_avg_report = mean(Avg_report))

print(groups)
print(head(participants))

```

## Distribution of reported numbers 

Our null hypothesis is that the reported values come from a uniform distribution, i.e. numbers from 1 to 6 are reported with the same probability, since we used a fair dice. Our alternative hypothesis is that participants cheat and report doubles in order to inflate their profit.  

This would lead to skewed distributions when the participant playes with a dishonest simulated partner who reports larger numbers with higher probability. In case of an honest simulated partner, whose dice throw values were sampled from a uniform distribution, we expect that the participants' reported values also come from a uniform ditribution (although it is possible that participants try to signal to their supposed partners to cheat by occassionally reporting 6s, but we do not expect this to create a significant difference).

We used chi-square tests to test whether the reported values come from a uniform distribution, separately for each group.

```{r chi-square JUDIT}


```

We also performed Kolmogorov-Smirnov tests to see whether the reported values come from a uniform distribution in each condition. We note, that Kolmogorov-Smirnov does not seem to be an appropriate test for this purpose, because this test is for continuous distributions. We used this test to make our results more comparable with...
* _KI HASZNALT KS-T??? WEISEL AND SHALVI, 2015-BEN NINCS!_  
* Two-sided for conditions with honest partner, one-sided for conditions with dishonest partner (because if they cheat, we expect them to report larger numbers)  

```{r Kolmogorov-Smirnov test}

group_SH <- filter(rawdata, Condition == "SH")
group_SD <- filter(rawdata, Condition == "SD")
group_CH <- filter(rawdata, Condition == "CH")
group_CD <- filter(rawdata, Condition == "CD")

fairdice_det <- rep(1:6, round(((N/4)*20)/6))
fairdice_rand <- sample(1:6, (N/4)*20, replace=TRUE)
fairdice_cdf <- ecdf(1:5)

ks.test(group_SH$ValueB, fairdice_det, alternative = "two.sided")
ks.test(group_SD$ValueB, fairdice_det, alternative = "greater")
ks.test(group_CH$ValueB, fairdice_det, alternative = "two.sided")
ks.test(group_CD$ValueB, fairdice_det, alternative = "greater")

```

We also made qqplots:

```{r qqplots ANNA}

par(pty="s") # square plotting region
qqplot(1:6, group_SH$ValueB, asp=1, xlab= "Uniform quantiles", ylab="Group SH quantiles")
qqplot(1:6, group_SD$ValueB, asp=1, xlab= "Uniform quantiles", ylab="Group SD quantiles")
qqplot(1:6, group_CH$ValueB, asp=1, xlab= "Uniform quantiles", ylab="Group CH quantiles")
qqplot(1:6, group_CD$ValueB, asp=1, xlab= "Uniform quantiles", ylab="Group CD quantiles")

```

## The number of doubles
Each participant ("dyad") is a single observation: the number of reported doubles  
Wilcoxon signed-rank U test, separately for each condition  
Expected value: 3.33 doubles/20 trials (16.7%; 20*1/6)  
(We could similarly test the mean of the reported numbers by player B, with an expected value of 3.5, but it does not make sense, because player A is simulated)  

```{r Wilcoxon signed-rank U test}

for (i in groups$Condition) {
  print(i)
  current <- filter(participants, Condition == i)
  w <- wilcox.test(current$Nbof_doubles, 3.33, alternative = "g")
  print(w)
}

```

## Compare the number of doubles in pairs of conditions
Mann-Whitney U test (or two-sample Wilcoxon test), one-sided.  

The effect of dishonest partners vs honest partners in the simple game and in the charity game:
```{r Mann-Whitney U test 1}
wilcox.test(participants_group_SH$Nbof_doubles, participants_group_SD$Nbof_doubles, conf.int = TRUE, alternative = "less")
wilcox.test(participants_group_CH$Nbof_doubles, participants_group_CD$Nbof_doubles, conf.int = TRUE, alternative = "less")
```

The effect of charity vs no charity with honest partner and with dishonest partner:
```{r Mann-Whitney U test 2}
wilcox.test(participants_group_SH$Nbof_doubles, participants_group_CH$Nbof_doubles, conf.int = TRUE, alternative = "less")
wilcox.test(participants_group_SD$Nbof_doubles, participants_group_CD$Nbof_doubles, conf.int = TRUE, alternative = "less")
```

## Effect size (ANNA)
To estimate the effect size of the honest-dishonest treatment let's compare the choices of participant Bs, who were paired with an honest A vs. a cheating A.  
Data: from the supplementary material of Weisel&Shalvy, 2015 and from Wouda et al., 2015  
https://www.statmethods.net/stats/power.html

```{r}

```

## Linear regression to test the effect of predictors (JUDIT)
Dependent variable: number of reported doubles (interval)  
Predictors: game (binary), partner (binary), fingerratio (interval), hormone levels (interval)  

```{r}

```


