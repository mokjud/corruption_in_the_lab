---
title: "Corruption in the lab"
author: "Fedor Anna, Mokos Judit"
date: "19/12/2018"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE) # global options
library(rmarkdown)
library(dplyr)
library(ggplot2)
```
# Description of the experiment
    
Sequential dyadic die-rolling task  

Two-by-two design:
    
* Game: simple game or charity game
* Partner: simulated honest partner or simulated dishonest partner  

Participants are randomly assigned to one of the four conditions:

* SH: simple game with honest partner
* SD: simple game with dishonest partner
* CH: charity game with honest partner
* CD: charity game with dishonest partner  

Each participant plays 20 rounds of the game. A round of game consists of the following steps:

1. Participant learns the reported number of the supposed partner
2. Participant throws a dice
3. Participant reports the number 
4. Both players get paid according to the reported numbers
5. In the charity game a charity foundation gets a small amount of donation  

# Dummy data

Data frame column names (each row is a dice roll):

* ID: random ID of participant (10000:99999)
* Game: simple or charity (S/C)
* Partner: honest or dishonest (H/D)
* Condition: one of the four experimental conditions (SH, SD, CH, CD)
* Index: index of round of game (1:20)
* ValueA: value of simulated dice roll (1:6)
* ValueB: value of participant's reported dice roll (1:6)
* Double: whether the participant reported a double (1/0)
* Q1: answer to first questionnaire quiestion (a random letter)
* Q2: answer to second questionnaire question (a random letter)
* Fingerratio: ratio of two fingers (normal distribution, mean=1, sd=0.1)
* Saliva: ??? (normal distribution, mean=3, sd=1)

```{r generate dummy data}

N = 1000 # number of participants in the dummy data

IDs <- sample(10000:99999, N)
games <- sample(c("S", "C"), N, replace=TRUE)
partners <- sample(c("H", "D"), N, replace=TRUE)

conditions = vector("character", N)
for (i in 1:N) {
  conditions[i] <- paste(games[i], partners[i], sep = "")
}

A_honest <- sample(1:6, 20, replace=TRUE)
A_dishonest <- sample(4:6, 20, replace=TRUE)


ValueAs <- vector("integer", N*20)
for (i in 1:N) {
  if (partners[i] == "H") {ValueAs[((i-1)*20+1) : ((i-1)*20+20)] <- A_honest}
  if (partners[i] == "D") {ValueAs[((i-1)*20+1) : ((i-1)*20+20)] <- A_dishonest}
}

fingerratios <- rnorm(N, mean = 1, sd = 0.1)
salivas <- rnorm(N, mean = 3, sd = 1)

rawdata <- data.frame("ID" = rep(IDs, times = 1, length.out = NA, each = 20), 
                      "Game" = rep(games, times = 1, length.out = NA, each = 20), 
                      "Partner" = rep(partners, times = 1, length.out = NA, each = 20), 
                      "Condition" = rep(conditions, times = 1, length.out = NA, each = 20),
                      "Index" = rep(1:20, N), 
                      "ValueA" = ValueAs, 
                      "ValueB" = sample(1:6, N*20, replace = TRUE), 
                      "Double" = vector("integer", N*20),
                      "Q1" = sample(letters, N*20, replace = TRUE), 
                      "Q2" = sample(letters, N*20, replace = TRUE),
                      "Fingerratio" = rep(fingerratios, times = 1, length.out = NA, each = 20),
                      "Saliva" = rep(salivas, times = 1, length.out = NA, each = 20))

doubles <- vector("integer", N*20)
for (i in 1:nrow(rawdata)){
  if (rawdata$ValueA[i] == rawdata$ValueB[i]){
      doubles[i] <- 1
  }
}

rawdata$Double <- doubles

```
# Data checking

* Check if every participant had 20 rounds
+ Delete participants who had less than 20 rounds
+ Delete excess rounds for each participant
* Check if there is any missing data (columns)

# Figures

## Scatter plots of individual behavior
These should be based on Weisel & Shalvi, 2015, Fig. S10.  
One plot per participant. Plots from the same condition should be compiled into one composite figure.  

```{r}



person <- as.factor(unique(rawdata$ID)) 
person <- person[1:5] #to try the figure ww will print only the first five subjects' reports. 


for(i in person){

  figure1 <- ggplot(data=filter(rawdata, ID==i), aes(x=Index))+
    geom_point(aes(y=ValueA), shape=1, size=5)+
    geom_point(aes( y=ValueB), shape=3, size=2)+
    theme_classic()+
  scale_x_continuous(name="Period")+
  scale_y_continuous(name="Report")
  
  cat("  \n### subject's ID:",  paste(i), "  \n")  
  print(figure1)
  cat("  \n")
}
```

## Heat map to demonstrate the distribution of reported numbers 
Like Weisel & Shalvi, 2015, Fig. 2, but instead of circles, each rectangle should be color coded according the number of observations within them.  
One figure per condition.  

```{r}

```

## Box plots of the mean number of doubles
One box for each condition on the same figure  
(Mean reports: does not make sense in our case, because player A is simulated)  

```{r}

```

# Statistics

## Summary of data
```{r}
participants <- summarize(group_by(rawdata, ID), 
                          Condition = unique(Condition), 
                          Nbof_doubles = sum(Double), 
                          Avg_report = mean(ValueB))

groups <- summarize(group_by(participants, Condition),
                    Nbof_participants = n_distinct(ID),
                    Nbof_doubles = sum(Nbof_doubles),
                    Avg_nbof_doubles = Nbof_doubles/Nbof_participants,
                    Avg_avg_report = mean(Avg_report))

print(groups)
```

## Distribution of reported numbers 
Kolmogorov-Smirnov, one per condition.  
Expected if they don't cheat: uniform distribution 1:6  
Two-sided for conditions with honest partner, one-sided for conditions with dishonest partner (because if they cheat, we expect them to report larger numbers)  
_NEM LENNE JOBB EGY CHI2? DISZKR?T V?LTOZ?, KEV?S (6) ?RT?KKEL. A KS TESZT FOLYAMATOS V?LTOZ?KRA VAN!_  
_Bocs, l?tom, hogy rosszul haszn?lom a ks.test-et! Ha te ismered a f?ggv?nyt, jav?tsd ki, l?gyszi!_  

```{r}
group_SH <- filter(rawdata, Condition == "SH")
group_SD <- filter(rawdata, Condition == "SD")
group_CH <- filter(rawdata, Condition == "CH")
group_CD <- filter(rawdata, Condition == "CD")

ks.test(group_SH$ValueB, punif(1:6, 1, 6), alternative = "two.sided")
ks.test(group_SD$ValueB, punif(1:6, 1, 6), alternative = "less")
ks.test(group_CH$ValueB, punif(1:6, 1, 6), alternative = "two.sided")
ks.test(group_CD$ValueB, punif(1:6, 1, 6), alternative = "less")

# just for fun
ks.test(group_SH$ValueA, punif(1:6, 1, 6), alternative = "two.sided")
ks.test(group_SD$ValueA, punif(1:6, 1, 6), alternative = "less")
ks.test(group_CH$ValueA, punif(1:6, 1, 6), alternative = "two.sided")
ks.test(group_CD$ValueA, punif(1:6, 1, 6), alternative = "less")

```

## The number of doubles
Each participant ("dyad") is a single observation: the number of reported doubles  
Wilcoxon signed-rank U test, separately for each condition  
Expected value: 3.33 doubles/20 trials (16.7%; 20*1/6)  
(We could similarly test the mean of the reported numbers by player B, with an expected value of 3.5, but it does not make sense, because player A is simulated)  

```{r}
participants_group_SH <- filter(participants, Condition == "SH")
wilcox.test(participants_group_SH$Nbof_doubles, 3.33, alternative = "g") #small sample size

participants_group_SD <- filter(participants, Condition == "SD")
wilcox.test(participants_group_SD$Nbof_doubles, 3.33, alternative = "g")

participants_group_CH <- filter(participants, Condition == "CH")
wilcox.test(participants_group_CH$Nbof_doubles, 3.33, alternative = "g")

participants_group_CD <- filter(participants, Condition == "CD")
wilcox.test(participants_group_CD$Nbof_doubles, 3.33, alternative = "g")
```

## Compare the number of doubles in pairs of conditions
Mann-Whitney U test (or two-sample Wilcoxon test)  
One-sided?  
_Nem n?ztem ut?na, hogy alternative="less"-t, vagy "greater"-t k?ne be?rni. Mi azt v?rjuk, hogy az y>x)_

The effect of dishonest partners vs honest partners in simple game and in the charity game:
```{r}
wilcox.test(participants_group_SH$Nbof_doubles, participants_group_SD$Nbof_doubles, conf.int = TRUE, alternative = "less")
wilcox.test(participants_group_CH$Nbof_doubles, participants_group_CD$Nbof_doubles)
```

The effect of charity vs no charity with honest partners and with dishonest partners:
```{r}
wilcox.test(participants_group_SH$Nbof_doubles, participants_group_CH$Nbof_doubles)
wilcox.test(participants_group_SD$Nbof_doubles, participants_group_CD$Nbof_doubles)
```

## Effect size
To estimate the effect size of the honest-dishonest treatment let's compare the choices of participant Bs, who were paired with an honest A vs. a cheating A  
Data: from the supplementary material of Weisel&Shalvy, 2015 and from Wouda et al., 2015  

```{r}

```

## Linear regression to test the effect of predictors
Dependent variable: number of reported doubles (interval)  
Predictors: game (binary), partner (binary), fingerratio (interval), hormone levels (interval)  

```{r}

```


