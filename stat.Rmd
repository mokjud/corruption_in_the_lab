---
title: "Corruption in the lab"
author: "Fedor Anna, Mokos Judit"
editor_options: null
output:
  word_document: default
  pdf_document: default
  html_document: default
chunk_output_type: console
---
  
```{r setup, include=FALSE}

rm(list=ls())
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(rmarkdown)
library(dplyr)
library(ggplot2)
library(knitr)

datafile = "C:/Users/fedor/OneDrive/Documents/DOKUMENTUMOK/Corruption.Project/GitHub/corruption_in_the_lab/power_simulations/RESULTS/20191002-090030_dummydata.RData"

participants_2plot <- 1

```

# Description of the experiment

Sequential dyadic die-rolling task. Two-by-two design:
  
  * Game: simple game or charity game
* Partner: simulated honest partner or simulated dishonest partner  

Participants are randomly assigned to one of the four conditions:
  
  * SH: simple game with honest partner
* SD: simple game with dishonest partner
* CH: charity game with honest partner
* CD: charity game with dishonest partner  

Each participant plays 20 rounds of the game. A round of game consists of the following steps:
  
  1. The reported number of the partner appears on the screen
2. Participant throws a dice privately
3. Participant reports the number 
4. Both players get a score according to the reported numbers: the score is the reported value, if they reported a double; otherwise it's 0
5. In the charity game a charity foundation gets a small amount of donation  

# Dummy data

Data frame column names (each row is a dice roll):

* ID: random ID of participant (10000:99999)
* Game: simple or charity (S/C)
* Partner: honest or dishonest (H/D)
* Condition: one of the four experimental conditions (SH, SD, CH, CD)
* Index: index of round of game (1:20)
* ValueA: value of simulated dice roll (1:6)
* ValueB: value of participant's reported dice roll (1:6)
* Double: whether the participant reported a double (1/0)
* Q1: answer to first questionnaire quiestion (a random letter)
* Q2: answer to second questionnaire question (a random letter)
* Fingerratio: ratio of two fingers (normal distribution, mean=1, sd=0.1)

```{r Generate dummy data}

load(datafile)

```
# Data checking

* Check if every participant had 20 round
+ Delete participants who had less than 20 rounds
+ Delete excess rounds for each participant
+ Delete participants who do not have questionnaire data
* Check if there is any missing data (columns)  

```{r Data checking}

```

# Figures

## Scatter plots of individual behavior
These plots are based on Weisel & Shalvi, 2015, Fig. S10. Each plot visualizes the behavior of one participant. Circles represent the simulated values of "player As", plus signs represent the reported values of player Bs.

```{r Scatter plots}

person <- as.factor(unique(rawdata$ID)) 

for(i in person[1]){
  #yourfilename=paste("figure1_", i, ".jpg",sep="") #filename for sacing
  #jpeg(file=yourfilename)
  
  figure1 <- ggplot(data=filter(rawdata, ID==i), aes(x=Index))+
    geom_point(aes(y=ValueA), shape=1, size=5)+
    geom_point(aes(y=ValueB), shape=3, size=2)+
    theme_classic()+
    scale_x_continuous(name="Round of game")+
    scale_y_continuous(name="Reported value")+
    ggtitle(paste("Participant ID: ", i, ", Condition: ", unique(filter(rawdata, ID==i)$Condition), sep=""))
  
  #cat(" subject's ID:",  paste(i), "  \n")  
  print(figure1)
  #dev.off() 
  cat("  \n")
  
}
```

## Heat map to demonstrate the distribution of reported numbers 
This plot is based on Weisel & Shalvi, 2015, Fig. 2. The heat maps show the behavior of player Bs in each condition. The rectangles in the matrices are color coded according to the number of observations in them.  

```{r Heat maps}

cond <- as.factor(unique(rawdata$Condition))
maximum <- max(count(rawdata, ValueA, ValueB, Condition)$n)

for(i in cond){
  heatmap_df <- data.frame(count(filter(rawdata, Condition==i), ValueA, ValueB))
  
  #yourfilename=paste("figure2_", i, ".jpg",sep="") #filename for sacing
  #jpeg(file=yourfilename)
  
  par(pty="s")
  figure2 <- ggplot(data=heatmap_df, aes(x=ValueA, y=ValueB))+
    geom_tile(aes(fill=n))+
    theme_classic()+
    scale_x_continuous(breaks=c(1:6), limits=c(0,7))+
    scale_y_continuous(breaks=c(1:6), limits=c(0,7))+
    scale_fill_gradient(low = "#F0F0F0", high = "black", na.value="white", limits=c(1, maximum), breaks=c(1:maximum), labels=c(1:maximum))+
    ggtitle(paste("Condition", i ))
  #cat("  \n Condition:",  paste(i), "  \n")  
  print(figure2)
  #dev.off()
  cat("  \n")
}

```

## Box plots of the mean number of doubles
The boxes show the distribution of the number of doubles in each condition. 
** FORDÍTOTT SORRENDBEN VANNAK A BOXOK!***

```{r Box plots}

cond <- as.factor(unique(rawdata$Condition))
number.of.doubles <-  count(filter(rawdata, Double==TRUE), ID, Condition)

figure3 <- ggplot(data= number.of.doubles, aes(y=n, group=Condition))+
  geom_boxplot()+
  theme_minimal()+
  scale_x_continuous(breaks=c(-0.3, -0.1, 0.1, 0.3), labels=c(as.character(cond)), name="Conditions")+
  scale_y_continuous(name='Number of doubles per 20 rounds')

#yourfilename=paste("figure3", ".jpg",sep="") #filename for sacing
#jpeg(file=yourfilename)
print(figure3)
#dev.off()

```

# Statistics

## Summary of data

```{r Create summary variables from raw data}

participants <- rawdata %>%
  group_by(ID) %>%
  summarize(
    Condition = unique(Condition), 
    Game = unique(Game),
    Partner = unique(Partner),
    Nbof_doubles = sum(Double), 
    Avg_report = mean(ValueB),
    Fingerratio = unique(Fingerratio))

groups <- participants %>%
  group_by(Condition) %>%
  arrange(desc(Condition)) %>%
  summarize(
    Nbof_participants = n_distinct(ID),
    Nbof_doubles_per_group = sum(Nbof_doubles),
    Avg_nbof_doubles = Nbof_doubles_per_group/Nbof_participants,
    Median_nbof_doubles = median(Nbof_doubles),
    Avg_avg_report = mean(Avg_report))
groups <- arrange(groups, desc(Condition))

kable(groups)

```

## Distribution of reported numbers 

Our null hypothesis is that the reported values come from a uniform distribution, i.e. numbers from 1 to 6 are reported with the same probability, since we used a fair dice. Our alternative hypothesis is that participants cheat and report doubles in order to inflate their profit.  

This would lead to skewed distributions when the participant playes with a dishonest simulated partner who reports larger numbers with higher probability. In case of an honest simulated partner, whose dice throw values were sampled from a uniform distribution, we expect that the participants' reported values also come from a uniform ditribution (although it is possible that participants try to signal to their supposed partners to cheat by occassionally reporting 6s, but we do not expect this to create a significant difference).

We used chi-square goodness of fit tests to test whether the reported values come from a uniform distribution, separately for each condition. We decided not to use Kolmogorov-Smirnov, despite that it has been used previously by others (Gachter, Schulz, 2016), BECAUSE The large number of ties in our sample makes this test unreliable.

```{r chi-square JUDIT}

probabilities <- c(rep(1/6, 6))

df.results <- data.frame(Condition=cond, df=NA, Chi.square=NA, p.value=NA)
for(i in cond)
{
  reported_B <- count(filter(rawdata, Condition==i), ValueB)$n
  results <- chisq.test(reported_B, p=probabilities, simulate.p.value = TRUE)
  
  df.results[which(df.results$Condition==i), ]$df <- results$parameter
  df.results[which(df.results$Condition==i), ]$Chi.square <- results$statistic
  df.results[which(df.results$Condition==i), ]$p.value <- results$p.value
  
  #cat("  \n Condition:",  paste(i), "  \n") 
  #print(results)

}

kable(df.results, digits=2)

```

We also made qqplots:  
** NEKEM EZ NEM TUNIK INFORMATÍVNAK, NE HAGYJUK KI???**

```{r qqplots}

honestvalues <- rep(1:6, 10000)
honestvalues_cdf <- ecdf(1:5)

for(i in cond)
{
  group_data <- filter(rawdata, Condition == i)
  par(pty="s")
  qqplot(group_data$ValueB, honestvalues, 
    main= paste("Condition:", i, ", Q-Q Plot"),
    xlab="Reported values",
    ylab= "Honest values")
  
  #cat("  \n Condition:",  paste(i), "  \n") 
  #print(figure_qqplot)
}

```

## The number of doubles
Ultimately, participants must report doubles, thus match their reported values to that of player A, in order to increase their payoff. The chi-square test cannot detect cheating in those groups where player A is "honest", even if player B cheats on each and every round, because the distribution of reported values would still come from a uniform distribution. Testing the mean of the reported numbers against an expected value of 3.5 does not make sense for the same reasons.
Therefore, we also tested, whether the number of doubles is higher than its expected value of 3.33 (the probability of throwing a double is 1/6; the expected number of doubles in 20 rounds is 20*1/6 = 3.33 in case of a fair dice and honest player) with Wilcoxon signed-rank U test, separately for each condition.

```{r Wilcoxon signed-rank U test}

w1 <- list()
for (i in groups$Condition) {
  current <- filter(participants, Condition == i)
  w1[[i]] <- wilcox.test(x=current$Nbof_doubles, mu=20/6, alternative = "greater")
}

results.wilcox.table1 <- data.frame(
  Condition = groups$Condition,
  p.value = c(w1[[1]]$p.value, w1[[2]]$p.value, w1[[3]]$p.value, w1[[4]]$p.value),
  W = c(w1[[1]]$statistic, w1[[2]]$statistic, w1[[3]]$statistic, w1[[4]]$statistic))

kable(results.wilcox.table1, digits=10)

```

## Compare the number of doubles in pairs of conditions
We compared the number of doubles in pairs of conditions with one-sided Mann-Whitney U test (or two-sample Wilcoxon test): the effect of dishonest partners vs honest partners in the simple game and in the charity game and the effect of charity vs no charity with honest partner and with dishonest partner.

The effect of dishonest partners vs honest partners in the simple game and in the charity game:
```{r Mann-Whitney U test 1}

w2 <- list()
w2[[1]] <- wilcox.test(x=filter(participants, Condition=="SH")$Nbof_doubles, y=filter(participants, Condition=="SD")$Nbof_doubles, conf.int = TRUE, alternative = "less" )
w2[[2]] <- wilcox.test(x=filter(participants, Condition=="CH")$Nbof_doubles, y=filter(participants, Condition=="CD")$Nbof_doubles, conf.int = TRUE, alternative = "less" )

results.wilcox.table2 <- data.frame(
  Condition = c("SH-SD", "CH-CD"),
  p.value = c(w2[[1]]$p.value, w2[[2]]$p.value),
  W = c(w2[[1]]$statistic, w2[[2]]$statistic))

kable(results.wilcox.table2, digits=10)

```

The effect of charity vs no charity with honest partner and with dishonest partner:
```{r Mann-Whitney U test 2}

w3 <- list()
w3[[1]] <- wilcox.test(x=filter(participants, Condition=="SH")$Nbof_doubles, y=filter(participants, Condition=="CH")$Nbof_doubles, conf.int = TRUE, alternative = "less" )
w3[[2]] <- wilcox.test(x=filter(participants, Condition=="SD")$Nbof_doubles, y=filter(participants, Condition=="CD")$Nbof_doubles, conf.int = TRUE, alternative = "less" )

results.wilcox.table3 <- data.frame(
  Condition = c("SH-CH", "SD-CD"),
  p.value = c(w3[[1]]$p.value, w3[[2]]$p.value),
  W = c(w3[[1]]$statistic, w3[[2]]$statistic))

kable(results.wilcox.table3, digits=10)

```

## The effect of predictors
We tested the effect of predictors with linear regression. The dependent variable was the number of reported doubles (interval) and predictors were game (binary), partner (binary) and fingerratio (interval).

```{r}

model1 <- lm(Nbof_doubles ~ Game + Partner + Fingerratio, data=participants)
summary1 <- summary(model1)
kable(summary1$coefficients, digits=3)

```

Residual standard error: `r round(summary1$sigma, 3)`  
Multiple R-squared: `r round(summary1$r.squared, 3)`  
Adjusted R-squared: `r round(summary1$adj.r.squared, 3)`  
F-statistic: `r round(summary1$fstatistic[[1]], 3)`  





